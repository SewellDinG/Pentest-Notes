《内网安全攻防：渗透测试实战指南》第7章：跨域攻击分析及防御

如果内网中存在多个域，就会面临跨域攻击。

本章对利用域信任关系实现跨域攻击的典型方法进行了分析，并对如何部署安全的内网生产环境给出了建议。

## 跨域攻击方法

大型企业一般通过域林进行共享资源。根据不同只能区分的部门，从逻辑上以主域和子域进行划分，以方便统一管理。在物理层，通常使用防火墙将各个子公司及各个部门划分为不同的区域。攻击者如果得到饿了某个子公司或者某个部门的域控制器全新啊，但没有得到整个公司内网的全部权限（或者需要的资源不在此域中），往往会想办法获取其他部门（或者域）的权限。

常见的跨域攻击方法有：**常规渗透方法（例如利用Web漏洞跨域获取权限）；利用已知域散列值进行哈希传递攻击或者票据传递攻击（例如DC的本地管理员密码相同）；利用域信任关系进行跨域攻击。**

## 域信任关系

默认情况下，特定Windows域中的所有用户都可以通过该域中的资源进行身份验证。

域信任的作用是解决多域环境中的跨域资源共享问题。域环境不会无条件的接受来自其他域的凭证，如果用户想要访问当前域边界以外的资源，需要使用域信任。**域信任作为域的一种机制，允许另一个域的用户在通过身份验证后访问本域的资源。**

从Windows 2003开始，域信任关系变为双向的，且可以通过信任关系进行传递。

只有Domain Admins组中的用户可以管理域信任关系。

在域中，Enterprise Admins组（仅出现在林的根域中）的成员具有对目录林中所有域的完全控制权限。默认情况下，该组包含林中所有域控制器上具有Administrator权限的成员。

获取域信息：lg.exe

利用**域信任秘钥（NTLM Hash）**获取目标域的权限：利用mimikatz导出信任秘钥并伪造信任票据（具有sidHistory）、利用asktgs请求TGS、利用kirbikator将TGS信息注入内存，获取目标域的权限。

使用mimikatz可以在构建黄金票据时设置sidHistory，因此，如果攻击者获取了任意域的krbtgt散列值，就可以利用sidHistory获得该林的完整权限。

利用**krbtgt散列值**获取目标域的权限：在DC上使用mimikatz获取krbtgt散列值、在子域使用普通用户权限构造并注入黄金票据，获取目标域的权限。

## 防范跨域攻击

外网Web往往会配置WAF以及配备维护人员定期安全检测，而内网的Web（内部办公、测试服务器等）更脆弱，往往存在弱口令和存在未及时补丁的漏洞。

在很多公司中，虽然为不同的部门划分了不同的域，但域管理员可能是同一批人，因此可能出现域管理员的用户名和密码相同的情况。**攻击者在获取当前域的DC权限后，要先检查DC的本地管理员密码是否与其他域的DC本地管理员密码相同。**



