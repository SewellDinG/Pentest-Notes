《内网安全攻防：渗透测试实战指南》第3章：隐藏通信隧道技术

网络隐藏通信隧道是与目标主机进行信息传输的主要工具。在大量TCP、UDP通信被防御系统拦截的情况下，DNS、ICMP等难以禁用的协议已经被攻击者利用，成为攻击者控制隧道的主要通道。

本章详细介绍了IPv6隧道、ICMP隧道、HTTPS隧道、SSH隧道、DNS隧道等加密隧道的使用方法，并对常见的SOCKS代理工具及内网上传/下载方法进行了解说。

## 判断内网的连通性

隐藏通信隧道技术常用于在访问受限的网络环境中追踪数据流向和在非受信任的网络中实现安全的数据传输。

在实际的网络中，通常会通过各种边界设备、软/硬件防火墙甚至入侵检测系统来**检查主机对外的网络连接情况**，如果发现异常，就会对通信进行阻断。

隧道，就是一种绕过端口屏蔽的通信方式。**防火墙两端的数据包通过防火墙所允许的数据包类型或者端口进行封装，然后穿过防火墙，与对方进行通信。当被封装的数据包到达目的地时，将数据包还原，并将还原后的数据包发送到相应的服务器上。**

e.g. ICMP（ping）、TCP/UDP（nc）、HTTP（curl）、**DNS（nslookup baidu.com VPS、dig baidu.com @VPS）**

## 网络层隧道技术（IPv6、ICMP）

IPv6隧道：可以将IPv4作为隧道载体，将IPv6报文整体封装在IPv4数据报文中。e.g. socat、6tunnel、nt6tunnel等

ICMP隧道：在一般的通信协议中，如果两台设备要进行通信，肯定需要开放端口，而在ICMP协议下就不需要。e.g. **icmpsh**、PingTunnel、icmptunnel、powershell icmp等

防御：检测数量、报文大小、特征标识等。一个正常的ping每秒最多发送两个数据包，而使用ICMP隧道数量会激增。

## 传输层隧道技术（TCP、UDP）

e.g. lcx、**netcat（nc -c参数）**、PowerCat

各种语言的反弹shell。

## 应用层隧道技术（SSH、HTTP/s、DNS）

**SSH：-CfNg，-L本地端口转发，-R远程端口转发，-D动态转发（SOCKS代理）**

防御：白名单、ACL限制请求IP。

**HTTP/s：reGeorg**、meterpreter、tunna等

DNS：DNS是一个必不可少的服务，DNS报文本身具有穿透防火墙的能力。

从DNS协议的角度看，只是在一次次的查询某个特定的域名并得到解析结果，但其本质问题是，预期的返回结果应该是一个IP地址，而事实返回的是任意字符串，包括加密的C2指令。

**DNS隧道本质是将其他协议封装在DNS协议中进行传输。**

## SOCKS代理

SOCKS是"SOCKetS"的缩写。

SOCKS4只支持TCP协议；SOCKS5不仅支持TCP/UDP协议，还支持各种身份验证机制。

SOCKS代理更底层，是在会话层；而HTTP代理是在应用层。因此SOCKS代理可以代理一切客户端的连接，而HTTP代理只能代理使用HTTP协议的客户端。由于更底层，不需要处理高级协议的细节，所以socks代理更快。

SOCKET被称作"套接字"，用于描述IP地址和端口，是一个通信链的句柄，可以用来实现不同计算机之间的通信，它的本质是编程接口(API)，是对TCP/IP的封装。SOCKS是一个代理协议，目前最新版本为SOCKS5，所谓代理就是，你可以通过它的去间接的访问网络，相当于一个中转站。区别：SOCKET是一个API，一个工具，让你建立网络连接用的。SOCKS是协议，是一组数据结构。

目前VPN隧道协议主要有4种：点到点隧道协议PPTP、第二层隧道协议L2TP、网络层隧道协议IPSec以及SOCKS v5协议。其中，PPTP和L2TP工作在数据链路层，IPSec工作在网络层，SOCKS v5工作在会话层。

e.g. EarthWorm（ew、新版本Termite）、reGeorg、sSocks、SocksCap64（SSTap）、Proxifier、ProxyChains

## 压缩数据

e.g. rar.exe、7z.exe

## 上传和下载

e.g. ftp、vbs、bitsadmin、powershell等等

Powershell的最大优势在于以.NET框架为基础，.NET框架在脚本领域几乎是无所不能的，因此ps1脚本文件的执行默认是被禁止的。
